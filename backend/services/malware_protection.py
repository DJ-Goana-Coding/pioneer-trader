"""
Red Flag Malware Hunter - V19 Security Layer
Zero-Trust AI Airlock for protecting the distributed hive
"""
from typing import Dict, List, Optional
import hashlib
import re
from datetime import datetime
from backend.core.config import settings

class RedFlagScanner:
    """Malware detection and protection system"""
    
    # Known malicious patterns (simplified for demo)
    MALICIOUS_PATTERNS = [
        r"eval\s*\(",
        r"exec\s*\(",
        r"__import__\s*\(",
        r"os\.system",
        r"subprocess\.",
        r"rm\s+-rf",
        r"DROP\s+TABLE",
        r"<script",
        r"javascript:",
    ]
    
    def __init__(self):
        self.scan_count = 0
        self.threats_detected = 0
        self.isolated_items: List[Dict] = []
        self.enabled = getattr(settings, 'ENABLE_MALWARE_PROTECTION', True)
        
    def scan_code(self, code: str, source: str = "unknown") -> Dict:
        """Scan code for malicious patterns"""
        self.scan_count += 1
        
        if not self.enabled:
            return {"status": "disabled", "threats": []}
        
        threats = []
        
        for pattern in self.MALICIOUS_PATTERNS:
            matches = re.finditer(pattern, code, re.IGNORECASE)
            for match in matches:
                threats.append({
                    "pattern": pattern,
                    "match": match.group(),
                    "position": match.start()
                })
        
        if threats:
            self.threats_detected += len(threats)
            self._isolate(code, source, threats)
            
        return {
            "status": "threat_detected" if threats else "clean",
            "threats": threats,
            "source": source,
            "timestamp": datetime.now().isoformat()
        }
    
    def scan_request_data(self, data: Dict, source: str = "api") -> Dict:
        """Scan API request data for malicious content"""
        self.scan_count += 1
        
        if not self.enabled:
            return {"status": "disabled", "threats": []}
        
        threats = []
        
        for key, value in data.items():
            if isinstance(value, str):
                for pattern in self.MALICIOUS_PATTERNS:
                    if re.search(pattern, value, re.IGNORECASE):
                        threats.append({
                            "field": key,
                            "pattern": pattern,
                            "value": value[:50]
                        })
        
        if threats:
            self.threats_detected += len(threats)
            self._isolate(str(data), source, threats)
            
        return {
            "status": "threat_detected" if threats else "clean",
            "threats": threats,
            "source": source,
            "timestamp": datetime.now().isoformat()
        }
    
    def _isolate(self, content: str, source: str, threats: List[Dict]):
        """Isolate potentially malicious content"""
        content_hash = hashlib.sha256(content.encode()).hexdigest()
        
        self.isolated_items.append({
            "hash": content_hash,
            "source": source,
            "threats": threats,
            "timestamp": datetime.now().isoformat(),
            "content_preview": content[:100]
        })
        
        print(f"⚠️ RED FLAG: Isolated threat from {source} - {len(threats)} patterns detected")
    
    def get_status(self) -> Dict:
        """Get scanner status"""
        return {
            "enabled": self.enabled,
            "scans_performed": self.scan_count,
            "threats_detected": self.threats_detected,
            "items_isolated": len(self.isolated_items),
            "status": "ARMED" if self.enabled else "DISABLED"
        }
    
    def get_isolated_items(self, limit: int = 10) -> List[Dict]:
        """Get list of isolated items"""
        return self.isolated_items[-limit:]
    
    def clear_isolated(self):
        """Clear isolated items (admin function)"""
        count = len(self.isolated_items)
        self.isolated_items = []
        return {"cleared": count}

# Global scanner instance
scanner = RedFlagScanner()
